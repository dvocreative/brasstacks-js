!function(root,factory){var ns="BrassTacks";"function"==typeof define&&define.amd?define(factory):"object"==typeof exports?module.exports=factory():root[ns]=factory()}(this,function(){var BTRoute=function(config,parentStack){this.parentStack=parentStack,this.children=[],this.redirect=!1,this.controllerScope=!1,this.runParentRoutes=!0,config&&this.build(config)};BTRoute.prototype={build:function(config){for(var prop in config)config.hasOwnProperty(prop)&&"routes"!==prop&&(this[prop]=config[prop]);if("string"==typeof this.url){this.parentStack.length&&(this.url=this.parentStack[this.parentStack.length-1].originalUrl+this.url),this.originalUrl=this.url;var toReg=this._routeToRegExp(this.url);this.url=toReg.url,this.params=toReg.params}},getId:function(){return this.id||!1},matchTo:function(urlToCompare){return urlToCompare.match(this.url)},addChild:function(route){this.children.push(route)},run:function(BT,args,payload,parentControllerResponse,overrideRunParents){var controllerResponse=null;if(this.redirect)return void BT.route(this.redirect,payload);if(!overrideRunParents&&this.runParentRoutes&&this.parentStack.length)for(var i=0,len=this.parentStack.length;len>i;i++)BT.halted||(parentControllerResponse=this.parentStack[i].run(BT,args,payload,parentControllerResponse,!0));return!BT.halted&&this.controller&&"function"==typeof this.controller&&(controllerResponse=this.controller.apply(this.controllerScope||BT,[args,payload,parentControllerResponse])),controllerResponse},mapArgs:function(args){var mapped={};if(args&&this.params)for(var i=0;i<args.length;i++)this.params[i]&&(mapped[this.params[i]]=args[i]);return mapped},_routeToRegExp:function(route){var optionalParam=/\((.*?)\)/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g,params=route.match(namedParam);if(params)for(var i=0;i<params.length;i++)params[i]=params[i].substring(1);return route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^/?]+)"}).replace(splatParam,"([^?]*?)"),{url:new RegExp("^"+route+"(?:\\?([\\s\\S]*))?$"),params:params}}};var BrassTacks=function(config){this.routes=[],this.routesById={},this.halted=!1,config&&this.add(config)};return BrassTacks.prototype={add:function(routeConfig,parent){var route=null;if("string"==typeof routeConfig.url||routeConfig.id){var stack=parent&&parent.parentStack.length?parent.parentStack.slice():[];parent&&stack.push(parent),route=this._processRoute(routeConfig,"undefined"!=typeof routeConfig.runParentRoutes&&routeConfig.runParentRoutes===!1?[]:stack)}if(routeConfig.routes)for(var i=0;i<routeConfig.routes.length;i++){var child=this.add(routeConfig.routes[i],route);route&&child&&route.addChild(child)}return route},route:function(urlOrRouteId,payload,notFoundCb){this.halted=!1;for(var splitUrlorId=urlOrRouteId.split("&"),i=0,len=splitUrlorId.length;len>i;i++){var route=null,params=null;if(route=this.routesById[splitUrlorId[i]],!route){var parsed=this._parseUrl(splitUrlorId[i]);route=parsed[0],params=parsed[1]}route?route.run(this,route.mapArgs(params),payload||{}):notFoundCb&&notFoundCb(splitUrlorId[i])}},getHashChangeHandler:function(win,payload){return function(win,btInstance){return function(){btInstance.route(win.location.hash.substr(1),payload)}}(win,this)},halt:function(){this.halted=!0},_processRoute:function(config,parentStack){var route=new BTRoute(config,parentStack);this.routes.push(route);var id=route.getId();return id&&(this.routesById[id]=route),route},_parseUrl:function(urlString){for(var route=null,i=this.routes.length,args=null;i--;){var result=this.routes[i].matchTo(urlString);if(result){result.shift(),args=result,route=this.routes[i];break}}return[route,args]}},BrassTacks});